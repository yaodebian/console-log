# Vite Series

## 请简单描述下 Vite 的原理

### 开发模式原理
1. 基于浏览器原生 ESM，而非预先打包
Vite 在开发阶段不再采用传统 bundler（如 Webpack）“先打包后启动”的模式，而是利用现代浏览器对 原生 ES Module（ESM） 的支持，将源码以模块的形式直接提供给浏览器。
服务器仅在模块被请求时对其进行必要的转换，因此开发服务器的启动时间不再与项目体量呈线性增长。

2. 依赖预构建（Pre-Bundling）
为了提高依赖加载效率，Vite 会在启动阶段使用 esbuild 对第三方依赖进行预构建。
该步骤的主要目的包括：
- 将 CommonJS 或 UMD 等格式转为浏览器可识别的 ESM；
- 将分散的依赖合并为少量模块，减少网络请求数；
- 通过 esbuild 的高性能编译能力显著提升构建速度。

3. 按需编译（On-Demand Transformation）
与传统 bundler 全量打包不同，Vite 采取 按需编译 策略：
当浏览器发起对某个模块的请求时，开发服务器才对该文件进行即时转换（如 TypeScript、Vue SFC 编译），然后返回给浏览器。

这一机制使得 Vite 的性能特性与项目规模相解耦，即使大型项目也可以获得极快的冷启动速度。

4. 模块路径重写（Import Rewriting）
浏览器无法直接识别裸模块导入（如 import vue from 'vue'）。
Vite 会在服务器端对模块导入路径进行重写，将其转换为基于预构建依赖的实际访问路径，从而确保浏览器能够正确加载依赖模块。

5. 高效的热模块更新（HMR）
Vite 的 HMR 基于 ESM 的模块化特性实现。
当源文件发生变更时，开发服务器仅对受影响的模块执行重新编译，并通知浏览器进行模块级别的替换。
这种更新方式无需重新打包整棵依赖图，因而具有 更细粒度、更低开销 的特点，使热更新速度几乎不受项目规模影响。

### 生产构建原理
**采用 Rollup 进行生产环境打包**
尽管 esbuild 在开发阶段表现优异，但在生产构建中，Vite 仍选择 Rollup 作为打包工具。
主要原因包括：
- Rollup 在 Tree-Shaking、代码分割等方面更成熟、可控；
- Rollup 插件生态完善，能满足复杂的构建需求；
- 产物质量更适合生产环境的稳定性要求。

因此，Vite 在开发阶段强调速度，而生产阶段侧重成熟的 bundling 能力，二者相互补充。

### 简化版
Vite 的核心原理可概括为“原生 ESM 驱动的按需编译”。
在开发环境中，Vite 不再进行传统的预打包，而是借助浏览器原生模块能力，按需向浏览器提供经轻量转换后的源代码；
同时，通过 esbuild 对第三方依赖进行预构建，以提升其加载效率。
借助模块级的路径重写与高效的 HMR 机制，Vite 能够在项目体积扩大时仍保持极快的冷启动与热更新性能。
而在生产环境中，Vite 使用 Rollup 完成最终构建，从而兼具高性能的开发体验与成熟可靠的生产打包能力。
